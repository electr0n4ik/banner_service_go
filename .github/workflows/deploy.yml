name: Deploy to Server

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  deploy:
    environment:
      name: banner_service_go # üëà –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–æ–±–∞–≤–ª—è–µ–º —ç—Ç–æ!
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts
          # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ –º–æ–∂–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —Ö–æ—Å—Ç–∞
          # echo "StrictHostKeyChecking no" >> ~/.ssh/config
      - name: Copy project to server
        run: |
          rsync -avz --delete -e "ssh -o StrictHostKeyChecking=no" ./ ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }}:/home/deployer/my-go-app/

      - name: Deploy to server
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} << 'EOF'
            cd /home/deployer/my-go-app

            # –ü–æ–ª–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –æ—á–∏—Å—Ç–∫–∞
            docker-compose down --rmi all --volumes --remove-orphans
            docker system prune -af
            
            # –°–æ–∑–¥–∞–µ–º —Å–µ—Ç—å, –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
            docker network create app-network || true
            
            # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥
            git pull origin main || git clone https://github.com/electr0n4ik/banner_service_go.git .
            
            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
            chmod +x scripts/*.sh 2>/dev/null || true
            
            docker-compose rm -sf frontend  # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —É–¥–∞–ª—è–µ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
            docker rmi $(docker images | grep frontend | awk '{print $3}')  # –£–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä—ã–π –æ–±—Ä–∞–∑
            
            # –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º
            docker-compose build --no-cache
            docker-compose up -d
            
            # –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞
            sleep 15
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
            docker-compose ps
            docker network inspect app-network
          EOF

      - name: Health Check
        run: |
          sleep 10
          ssh ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} << 'EOF'
            curl -f http://localhost/api/v1/health || curl -f http://localhost:8080/health || echo "Health check failed"
          EOF
      - name: Check current files
        run: |
          ssh ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} << 'EOF'
            cd /home/deployer/my-go-app
            git status
            git log -1
            ls -l ./frontend/index.html
          EOF

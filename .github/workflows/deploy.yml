name: Deploy to Server

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  deploy:
    environment:
      name: banner_service_go # üëà –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–æ–±–∞–≤–ª—è–µ–º —ç—Ç–æ!
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Copy project to server
        run: |
          rsync -avz --delete -e "ssh -o StrictHostKeyChecking=no" ./ ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }}:/home/deployer/my-go-app/

      - name: Deploy to server
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} << 'EOF'
            cd /home/deployer/my-go-app\

            # –°–æ–∑–¥–∞–µ–º .env —Ñ–∞–π–ª
            cat > .env << 'ENVEOF'
              JWT_SECRET=${{ secrets.JWT_SECRET }}
              # DB_HOST=localhost
              # DB_PORT=5432
              # DB_NAME=banner_service
              # DB_USER=postgres
              # DB_PASSWORD=12345
              # –Ω–∞ –±—É–¥—É—â–µ–µ –¥—Ä—É–≥–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
            ENVEOF

            # –ò—Å–ø—Ä–∞–≤–ª—è–µ–º DNS –¥–ª—è Docker
            sudo systemctl restart docker
            # –ò–ª–∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å systemd-resolved
            # sudo systemctl restart systemd-resolved
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º DNS
            # nslookup registry-1.docker.io

            # –ü–æ–ª–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –æ—á–∏—Å—Ç–∫–∞
            docker-compose down --rmi all --volumes --remove-orphans
            docker system prune -af
            
            # –°–æ–∑–¥–∞–µ–º —Å–µ—Ç—å, –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
            docker network create app-network || true

            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
            chmod +x scripts/*.sh 2>/dev/null || true
            
            # –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º
            docker-compose build --no-cache
            docker-compose up -d
            
            # –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞
            sleep 15
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
            docker-compose ps
          EOF

      - name: Health Check
        run: |
          sleep 10
          ssh ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} << 'EOF'
            curl -f http://localhost/api/v1/health || curl -f http://localhost:8080/health || echo "Health check failed"
          EOF
      - name: Check current files
        run: |
          ssh ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} << 'EOF'
            cd /home/deployer/my-go-app
            git status
            git log -1
            ls -l ./frontend/index.html
          EOF
